<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ONS Chart</title>

    <!-- Chart.js makes charts easy -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body { font-family: Arial, sans-serif; margin: 24px; }
      .wrap { max-width: 900px; margin: 0 auto; }
      .note { color: #444; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>My ONS Chart</h1>
      <p class="note">If it says “Loaded points”, it worked.</p>

      <canvas id="chart" height="120"></canvas>
      <p id="status"></p>
    </div>

    <script>
      // 1) This is the ONS API address we are reading from.
      // You can swap this later for a different dataset.
      const ONS_URL =
        "https://api.beta.ons.gov.uk/v1/datasets/cpih01/editions/time-series/versions/6/observations?time=*&geography=K02000001&aggregate=cpih1dim1A0";

      const statusEl = document.getElementById("status");

      async function run() {
        statusEl.textContent = "Loading data from ONS...";

        // 2) Download the data (JSON)
        const res = await fetch(ONS_URL);

        if (!res.ok) {
          throw new Error("ONS request failed: " + res.status + " " + res.statusText);
        }

        const data = await res.json();

        // 3) Get observations list
        const obs = data.observations || [];
        if (obs.length === 0) {
          throw new Error("No observations returned. The API link might be wrong.");
        }

        // 4) Convert observations into points {x, y}
      const points = obs
  .map(o => {
    const dims = o.dimensions || {};

    // Get time safely (works for ONS object-style dimensions)
    const timeDim = dims.time;
    const timeLabel =
      timeDim?.option?.label ||
      timeDim?.option?.id ||
      "";

    const value = Number(o.observation);
    return { x: timeLabel, y: value };
  })
  .filter(p => p.x && Number.isFinite(p.y));
        

        // 5) Sort points by time (so it draws left-to-right nicely)
        points.sort((a, b) => a.x.localeCompare(b.x));

        // 6) Draw the chart
        const ctx = document.getElementById("chart");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: points.map(p => p.x),
            datasets: [
              {
                label: "ONS value",
                data: points.map(p => p.y)
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false }
          }
        });

        statusEl.textContent = "Loaded " + points.length + " points from ONS ✅";
      }

      run().catch(err => {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
      });
    </script>
  </body>
</html>
